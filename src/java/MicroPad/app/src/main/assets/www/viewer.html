<html>
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
	<link type="text/css" rel="stylesheet" href="css/materialize.min.css"  media="screen,projection"/>
	<style>
		#MathJax_Message {
			display: none;
		}

		#content {
			position: relative;
			width: 100%;
			height: 100%;
		}

		#content.empty {
			background-image: url('img/white-lines.png');
		}

		.handle {
			position: absolute;
			text-align: center;
			user-select: none;
			width: 100%;
			left: 0;
			right: 0;
			margin: auto;
			cursor: move;
		}

		#content > div {
			position: absolute;
			min-width: 170px;
			min-height: 50px;
			padding: 5px;
			word-wrap: break-word;
			overflow: auto;
			transition: box-shadow .2s;
		}
	</style>
</head>
<body>
	<div id="content" class="empty"></div>

	<!-- JS Libs -->
	<script src="js/jquery-3.1.1.min.js"></script>
	<script src="js/materialize.min.js"></script>
	<script src="js/interact.min.js"></script>
	<script>window.MathJax = { MathML: { extensions: ["mml3.js", "content-mathml.js"]}};</script>
	<script type="text/javascript" async src="js/MathJax/MathJax.js?config=MML_HTMLorMML"></script>
	<script src="js/showdown.min.js"></script>
	<script src="js/ASCIIMathML.js"></script>
	<script type="text/javascript">String.prototype.format||(String.prototype.format=function(){var a=arguments;return this.replace(/{(\d+)}/g,function(b,c){return"undefined"!=typeof a[c]?a[c]:b})});</script>
	
	<!-- JS Code -->
	<script type="text/javascript">
		showdown.extension('math', function() {
			var matches = [];
			return [
				{
					type: 'lang',
					regex: /===([^]+?)===/gi,
					replace: function(s, match) {
						matches.push('===' + match + '===');
						var n = matches.length - 1;
						return '%PLACEHOLDER' + n + '%';
					}
				},
				{
					type: 'output',
					filter: function(text) {
						for (var i = 0; i < matches.length; ++i) {
							var pat = '%PLACEHOLDER' + i + '%';
							text = text.replace(new RegExp(pat, 'gi'), matches[i]);
						}
						//reset array
						matches = [];
						return text;
					}
				}
			]
		});

		var md = new showdown.Converter({
			parseImgDimensions: true,
			simplifiedAutoLink: true,
			strikethrough: true,
			tables: true,
			tasklists: true,
			prefixHeaderId: 'mdheader_',
			smoothLivePreview: true,
			extensions: ['math']
		});

		function resizePage(element) {
			if (parseInt($(element).css('left')) + $(element).width() + 1000 > parseInt($('#content').css('width'))) {
				$('#content').css('width', parseInt($(element).css('left')) + $(element).width() + 1000 + 'px');
			}
			if (parseInt($(element).css('top')) + $(element).height() + 1000 > parseInt($('#content').css('height'))) {
				$('#content').css('height', parseInt($(element).css('top')) + $(element).height() + 1000 + 'px');
			}
		}

		function displayElement(id, content, x, y, width, height, extraArgs) {
			var contentDiv = document.getElementById("content");
			$(contentDiv).removeClass('empty');
			contentDiv.innerHTML += '<div id="{0}" class="drag z-depth-2" style="left: {1}; top: {2}; width: {3}; height: {4};"><p class="handle">::::</p></div>'.format(id, x, y, width, height);
			var elementDiv = document.getElementById(id);

			content = decodeURIComponent(content);

			switch (id.split(/[0-9]/)[0]) {
				case "markdown":
					elementDiv.style.fontSize = extraArgs.fontSize;
					elementDiv.innerHTML += md.makeHtml(content);
					asciimath.translate(undefined, true);

					setTimeout(() => {
						MathJax.Hub.Typeset();
					}, 1000);
					break;
			}
			resizePage(elementDiv);

			$('.drag').draggable({
				handle: ".handle",
				stack: ".drag",
				start: event => {
					$(event.currentTarget).removeClass('z-depth-2');
					$(event.currentTarget).addClass('z-depth-4');

					navigator.vibrate = navigator.vibrate || navigator.webkitVibrate || navigator.mozVibrate || navigator.msVibrate;
					navigator.vibrate(100);
				},
				drag: event => {
					resizePage(event.target);
					//TODO: Send to Java
				},
				stop: event => {
					$(event.target).removeClass('z-depth-4');
					$(event.target).addClass('z-depth-2');
				}
			});
		}
	</script>
</body>
</html>